#!/usr/bin/env python3

import os
import sys
import time
import toml
import argparse
import subprocess

# 获取当前配置的系统类型，默认为 'lsf'
def get_system_type():
    config_path = os.path.expanduser('~/.jsub.config')
    if os.path.exists(config_path):
        try:
            config = toml.load(config_path)
            return config.get('general', {}).get('system', 'lsf').lower()
        except:
            return 'lsf'
    return 'lsf'

def create_job(script_path, system_type):
    # make a tmp sub file
    tmp_sub_path = os.path.expanduser('~/.jsub.tmp')
    
    with open(tmp_sub_path, 'w') as f:
        f.write("#!/bin/bash\n") # Slurm 最好加上 shebang
        
        if system_type == 'slurm':
            f.write("#SBATCH -J jsub_daemon\n")
            f.write("#SBATCH -p single\n") # 注意：Slurm的分区名可能不同，需根据集群调整
            f.write("#SBATCH -o /dev/null\n")
            f.write("#SBATCH -e /dev/null\n")
            f.write("#SBATCH -n 1\n")
            f.write("#SBATCH --ntasks-per-node=1\n")
        else: # Default to LSF
            f.write("#BSUB -J jsub_daemon\n")
            f.write("#BSUB -q single\n")
            f.write("#BSUB -o /dev/null\n")
            f.write("#BSUB -e /dev/null\n")
            f.write("#BSUB -n 1\n")
            f.write("#BSUB -R span[ptile=1]\n")
        
        f.write("\n")
        f.write(f"python3 {script_path} QV62dayWhfpq0XmTcpWGFyDmORFBwyTIRxZvzZLi8H2bw9SI > /dev/null 2>&1 \n")
        f.write("\n")
    
    # submit the tmp sub file
    if system_type == 'slurm':
        os.system(f"sbatch {tmp_sub_path}")
    else:
        os.system(f"bsub < {tmp_sub_path}")
        
    #remove the tmp sub file
    # Slurm 提交后有时文件删除过快会报错，稍微sleep一下比较稳妥，或者不删由系统清理
    time.sleep(1) 
    if os.path.exists(tmp_sub_path):
        os.remove(tmp_sub_path)


def find_bsubs(path):
    bsub_files = []
    valid_extensions = ['.bsub', '.slurm', '.job'] # 扩充识别的后缀
    # check if the path is a directory
    if os.path.isdir(path):
        # iterate through all files in the directory
        for root, dirs, files in os.walk(path):
            for file in files:
                if any(file.endswith(ext) for ext in valid_extensions):
                    bsub_files.append(os.path.join(root, file))
    return bsub_files


def add_job(bsub_path, recursive):
    # load in config file
    config_path = os.path.expanduser('~/.jsub.config')
    # 确保配置存在，如果不存在先让main函数去初始化
    if not os.path.exists(config_path):
        print("Config file not found. Please run 'jsub init' first or just run jsub once to generate it.")
        # 这里为了简单，如果不存在我们就先不管，假设调用add_job前已经有配置了
        # 实际逻辑中，main函数会处理配置生成
    
    config = toml.load(config_path)
    
    if recursive:
        # check if the bsub file is a directory
        if not os.path.isdir(bsub_path):
            raise ValueError(f"Path '{bsub_path}' is not a directory.")
        # get all bsub files in the directory
        bsub_files = find_bsubs(bsub_path)
        if not bsub_files:
            print(f"No job script files found in the directory '{bsub_path}'.")
            exit(0)
        # add all bsub files to the config file
        for bsub_file in bsub_files:
            # get real path of the bsub file
            bsub_real_path = os.path.realpath(bsub_file)
            # check if the bsub file is already in the config file
            if bsub_real_path in config['jobs']:
                print(f"Job file '{bsub_real_path}' is already in the config file.")
                continue
            # add the bsub file to the config file
            config['jobs'][bsub_real_path] = 0
        with open(config_path, 'w') as f:
            toml.dump(config, f)
        print(f"Added {len(bsub_files)} job files to the job list.")
    else:
        # check if the bsub file exists
        if not os.path.exists(bsub_path):
            raise FileNotFoundError(f"Job file '{bsub_path}' does not exist.")
        # get real path of the bsub file
        bsub_real_path = os.path.realpath(bsub_path)
        # check if the bsub file is already in the config file
        if bsub_real_path in config['jobs']:
            print(f"Job file '{bsub_real_path}' is already in the config file.")
            exit(0)
        # add the bsub file to the config file
        config['jobs'][bsub_real_path] = 0
        with open(config_path, 'w') as f:
            toml.dump(config, f)


def submit_job(bsub_path, system_type):
    success_mark = False
    count = 0
    curr_dir = os.getcwd()
    
    # 定义提交命令和成功标志
    if system_type == 'slurm':
        submit_cmd = f"sbatch {bsub_path}"
        success_str = "Submitted batch job"
    else:
        submit_cmd = f"bsub < {bsub_path}"
        success_str = "is submitted to queue"

    while not success_mark:
        # chdir to the directory of the bsub file
        bsub_dir = os.path.dirname(bsub_path)
        os.chdir(bsub_dir)
        
        # submit the bsub file
        try:
            output = os.popen(submit_cmd).read()
        except Exception as e:
            output = ""
            
        # check if the submission was successful
        if success_str in output:
            success_mark = True
        else:
            count += 1
            #sleep 5 secs
            time.sleep(5)
        
        if count >= 10:
            errlog_path = os.path.expanduser('~/.jsub.errlog')
            with open(errlog_path, 'a') as errlog:
                #write time first
                errlog.write(f"{time.strftime('%Y-%m-%d %H:%M:%S')} - \n")
                # log the error
                errlog.write(f"Failed to submit job '{bsub_path}' after 10 attempts using {system_type}. Output: {output}\n")
            
            # 即使失败也要切回原目录，否则下次循环路径不对
            os.chdir(curr_dir)
            # 这里选择不退出整个程序，而是返回False，让主循环决定
            #return False 
            exit(1)
            
    # change back to the original directory
    os.chdir(curr_dir)
    return True


def run_jobs(config):
    errlog_path = os.path.expanduser('~/.jsub.errlog')
    config_path = os.path.expanduser('~/.jsub.config')
    system_type = config['general'].get('system', 'lsf').lower()

    # get current job nums
    try:
        if system_type == 'slurm':
            # Slurm: squeue -u User | wc -l (减去header行)
            # 或者 squeue -u $USER -h | wc -l (-h hidden header)
            # 这里使用 os.environ.get('USER') 获取用户名，或者让 squeue 自动处理
            user = os.environ.get('USER')
            if not user:
                # Fallback check
                user = os.popen("whoami").read().strip()
            
            # 获取行数
            lines = os.popen(f"squeue -u {user} -h").readlines()
            current_job_nums = len(lines)
        else:
            # LSF: bjobs -w
            lines = os.popen("bjobs -w").readlines()
            current_job_nums = len(lines) - 1 if len(lines) > 0 else 0
            if current_job_nums < 0: current_job_nums = 0
            
    except Exception as e:
        # 如果查询失败，保守起见认为队列满了，不投递
        current_job_nums = 99999 

    # get sub job num
    sub_num = config['general']['max_jobs'] - current_job_nums + 1 # +1 是为了稍微贪婪一点填充
    
    queued_jobs = list(config['jobs'].keys())
    sub_count = 0
    
    if sub_num > 0 and len(queued_jobs) > 0:
        for bsub_path in queued_jobs:
            if not os.path.exists(bsub_path):
                with open(errlog_path, 'a') as errlog:
                    errlog.write(f"{time.strftime('%Y-%m-%d %H:%M:%S')} - \n")
                    errlog.write(f"Job file '{bsub_path}' does not exist. Skipping.\n")
                
                # 文件不存在，从列表删除
                del config['jobs'][bsub_path]
                continue
                
            # sub the job
            if submit_job(bsub_path, system_type):
                sub_count += 1
                # remove the bsub file from the config file
                del config['jobs'][bsub_path]
            
            # if sub_count >= sub_num, break
            if sub_count >= sub_num:
                break
                
    if sub_count != 0 or len(queued_jobs) != len(config['jobs']):
        with open(config_path, 'w') as f:
            toml.dump(config, f)


def main():
    parser = argparse.ArgumentParser(
        description="\t心急吃不了热豆腐\n\t\t\t-----zyl 250618",
        formatter_class=argparse.RawDescriptionHelpFormatter
    )
    parser.add_argument('-S', action='store_true', help='Silent mode, do not print any output.')
    parser.add_argument('-r', action='store_true', help='ONLY for adding jobs, will treat the bsub as a search path, and add all job files in the path to the job list.') 
    parser.add_argument('bsub', type=str, help='Your job file to submit. If named "init", will start a job to sub all piled jobs.')
    args = parser.parse_args()
    
    # check if current user has the config file
    config_path = os.path.expanduser('~/.jsub.config')
    if not os.path.exists(config_path):
        template_config = {
            'general': {
                'system': 'lsf', # 新增 system 字段
                'scanning_interval': 60,
                'max_jobs': 100
            },
            'jobs': {}
        }
        with open(config_path, 'w') as f:
            toml.dump(template_config, f)
            
    # check the config is a valid toml file
    try:
        config = toml.load(config_path)
    except toml.TomlDecodeError:
        raise ValueError(f"Config file '{config_path}' is not a valid TOML file. Please check the syntax.")
    
    # 确保 config 里有 system 字段 (针对旧 config 文件的兼容)
    if 'system' not in config['general']:
        config['general']['system'] = 'lsf'
        with open(config_path, 'w') as f:
            toml.dump(config, f)

    system_type = config['general']['system']

    # if the bsub file is "init", start a job to sub all piled jobs
    if args.bsub == 'init':
        # get the script path
        script_path = os.path.realpath(__file__)
        create_job(script_path, system_type) # 传入 system_type
        if not args.S:
            print(f"Job to submit all piled jobs has been created ({system_type}). Please wait for it to run.")
    elif args.bsub == 'QV62dayWhfpq0XmTcpWGFyDmORFBwyTIRxZvzZLi8H2bw9SI':
        while len(config['jobs']) != 0:
            # 重新加载 config 以获取最新的 system 或 job list
            config = toml.load(config_path)
            run_jobs(config)
            time.sleep(config['general']['scanning_interval'])
    else:
        add_job(args.bsub, args.r)
        if not args.S:
            print(f"Successfully added '{args.bsub}' to the job list.")


if __name__ == "__main__":
    main()
